<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi ti·∫øt s√°ch</title>
  <link rel="stylesheet" href="/static/login.css">
  <link rel="stylesheet" href="/static/book_detail.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <!-- Header -->
  <header>
    <div class="left-header">
      <div class="logo">üìö Book_shop</div>
      <nav>
        <a href="/">Trang Ch·ªß</a>
        <a href="#">Combo gi·∫£m gi√°</a>
        <a href="#">Th·ªÉ Lo·∫°i</a>
        <a href="{{ url_for('gio_hang') }}">Gi·ªè H√†ng</a>
      </nav>
    </div>
    <div class="search-login">
      <input type="text" placeholder="N·ªôi dung t√¨m ki·∫øm">
      <button class="btn-tim">T√¨m</button>
      {% if is_logged_in %}
        <span>Xin ch√†o, {{ username }}!</span>
        <a href="/logout"><button class="btn-dangnhap">ƒêƒÉng xu·∫•t</button></a>
      {% else %}
        <a href="/login"><button class="btn-dangnhap">ƒêƒÉng nh·∫≠p</button></a>
      {% endif %}
    </div>
  </header>

  <!-- N·ªôi dung s√°ch -->
  <main class="container mt-5">
    <div class="row">
      <div class="col-md-5">
        <img src="{{ img or '/static/images/default.jpg' }}" class="img-fluid" alt="{{ title }}">
      </div>
      <div class="col-md-7">
        <h2 class="fw-bold" id="bookTitle">{{ title or 'Kh√¥ng r√µ ti√™u ƒë·ªÅ' }}</h2>
        <p><strong>T√°c gi·∫£:</strong> {{ author or 'Kh√¥ng r√µ' }}</p>
        <p><strong>Th·ªÉ lo·∫°i:</strong> {{ category or 'Kh√¥ng r√µ' }}</p>
        <p><strong>Nh√† xu·∫•t b·∫£n:</strong> {{ publisher or 'Kh√¥ng r√µ' }}</p>
        <p><strong>NƒÉm xu·∫•t b·∫£n:</strong> {{ year or 'Kh√¥ng r√µ' }}</p>
        <p><strong>Gi√° b√°n:</strong> <span class="text-danger fw-bold" id="bookPrice">{{ price or '0' }} VNƒê</span></p>
        <p class="mt-3"><strong>M√¥ t·∫£:</strong> {{ desc or 'Kh√¥ng c√≥ m√¥ t·∫£' }}</p>
        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-success"
                  onclick="addToCart('{{ title }}', '{{ price }}', '{{ img }}')">
            Th√™m v√†o gi·ªè h√†ng
          </button>
          <button class="btn btn-primary" onclick="buyNow('{{ title }}', '{{ price }}', '{{ img }}')">Mua ngay</button>
        </div>
      </div>
    </div>
  </main>

  <!-- S·∫£n ph·∫©m li√™n quan -->
  <section class="container mt-5">
    <h3>S·∫£n ph·∫©m Li√™n Quan</h3>
    <div class="row">
      {% for p in all_products %}
      <div class="col-md-3 mb-4">
        <div class="card h-100">
          <img src="{{ p.hinhanh or '/static/images/default.jpg' }}" class="product-img" alt="·∫¢nh s·∫£n ph·∫©m">
          <div class="card-body">
            <h5 class="product-title">{{ p.tensanpham }}</h5>
            <p>{{ (p.mota[:80] ~ '...') if p.mota else 'Kh√¥ng c√≥ m√¥ t·∫£' }}</p>
<p class="text-danger fw-bold">{{ "{:,.0f}".format(p.giaban) }} vnƒë</p>
            <a href="{{ url_for('book_detail',
                                title=p.tensanpham,
                                img=p.hinhanh,
                                desc=p.mota,
                                price=p.giaban,
                                author=p.tacgia.hovaten if p.tacgia else 'Kh√¥ng r√µ',
                                category=p.theloai.tentheloai if p.theloai else 'Kh√¥ng r√µ',
                                publisher='NXB n√†o ƒë√≥',
                                year=p.namxuatban or 2024) }}" class="btn btn-outline-primary">Chi ti·∫øt</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>

  <!-- Footer -->
  <div class="footer py-4 mt-5">
    <hr />
    <div class="container">
      <div class="row g-4">
        <div class="col-md-4">
          <div class="h5 fw-bold mb-3">BookSach_360.vn</div>
          <div class="social-icons">
            <a href="#" class="me-2">Facebook</a>
            <a href="#" class="me-2">Twitter</a>
            <a href="#" class="me-2">YouTube</a>
            <a href="#" class="me-2">Instagram</a>
          </div>
        </div>
        <div class="col-md-4">
          <ul class="list-unstyled">
            <li>Li√™n h·ªá: quanlysach_360@gmail.com</li>
            <li>Quy ƒë·ªãnh giao h√†ng</li>
            <li>Quy ƒë·ªãnh tr·∫£ h√†ng</li>
          </ul>
        </div>
        <div class="col-md-4">
          <ul class="list-unstyled">
            <li>Ch√≠nh s√°ch ho·∫°t ƒë·ªông</li>
            <li>Ch√≠nh s√°ch tr·∫£ h√†ng</li>
            <li>Ch√≠nh s√°ch b·∫£o m·∫≠t</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
<script>
    function addToCart(bookTitle, bookPrice, bookImg) {
      fetch("/add_to_cart", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          title: bookTitle,
          price: parseFloat(bookPrice),
          img: bookImg
        })
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
      })
      .catch(error => {
        console.error("L·ªói:", error);
        alert("C√≥ l·ªói x·∫£y ra khi th√™m v√†o gi·ªè h√†ng.");
      });
    }

    function buyNow(bookTitle, bookPrice, bookImg) {
  fetch("/add_to_cart", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      title: bookTitle,
      price: parseFloat(bookPrice),
      img: bookImg
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // ƒê√£ th√™m ho·∫∑c ƒë√£ c√≥ r·ªìi => chuy·ªÉn ƒë·∫øn gi·ªè h√†ng
      window.location.href = "/giohang";
    } else {
      alert(data.message);
      if (data.message.includes("ƒëƒÉng nh·∫≠p")) {
        window.location.href = "/login"; // Chuy·ªÉn ƒë·∫øn login n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
      }
    }
  })
  .catch(error => {
    console.error("L·ªói:", error);
    alert("C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω mua ngay.");
  });
}
  </script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>